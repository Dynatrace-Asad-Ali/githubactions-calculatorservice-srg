name: CI - Dynatrace SRG Evaluation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      startTime: ${{ steps.times.outputs.startTime }}
      endTime: ${{ steps.times.outputs.endTime }}
    steps:
      - name: Calculate time window
        id: times
        run: |
          # produce UTC timestamps for the evaluation window
          START=$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ)
          END=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "startTime=$START" >> $GITHUB_OUTPUT
          echo "endTime=$END" >> $GITHUB_OUTPUT

  evaluation:
    needs: test
    runs-on: ubuntu-latest
    container:
      image: "dynatraceace/dt-automation-cli:latest"
    steps:
      - name: "Run SRG evaluation"
        env:
          LOG_LEVEL: "verbose"
          DYNATRACE_URL_GEN3: ${{ secrets.DYNATRACE_URL_GEN3 }}
          ACCOUNT_URN: ${{ secrets.ACCOUNT_URN }}
          DYNATRACE_CLIENT_ID: ${{ secrets.DYNATRACE_CLIENT_ID }}
          DYNATRACE_SECRET: ${{ secrets.DYNATRACE_SECRET }}
          # DYNATRACE_SSO_URL: ${{ secrets.DYNATRACE_SSO_URL }}
          SRG_EVALUATION_STOP_ON_FAILURE: "true"
          SRG_EVALUATION_SERVICE: "demo"
          SRG_EVALUATION_STAGE: "dev"
          SRG_EVALUATION_START_TIME: ${{ needs.test.outputs.startTime }}
          SRG_EVALUATION_END_TIME: ${{ needs.test.outputs.endTime }}
          SRG_EVALUATION_VERSION: "1.0.0"
          SRG_EVALUATION_BUILD_ID: ${{ github.run_id }}
          SRG_EVALUATION_DELAY: 5
        run: |
          dta srg evaluate